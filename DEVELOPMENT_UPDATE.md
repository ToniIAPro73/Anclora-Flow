# Anclora Flow - Actualizaci√≥n de Desarrollo

## Resumen de Cambios

Este documento detalla las actualizaciones implementadas en la aplicaci√≥n Anclora Flow, incluyendo la arquitectura completa del backend, base de datos, y el desarrollo completo de los m√≥dulos de Gastos y Clientes.

---

## üóÑÔ∏è Base de Datos

### Estructura Implementada

Se ha dise√±ado e implementado una base de datos PostgreSQL completa con las siguientes tablas:

#### Tablas Principales

1. **users** - Gesti√≥n de usuarios con autenticaci√≥n local y OAuth
2. **clients** - Registro de clientes con informaci√≥n fiscal
3. **projects** - Proyectos asociados a clientes
4. **invoices** - Facturas con c√°lculos fiscales (IVA, IRPF)
5. **invoice_items** - L√≠neas de detalle de facturas
6. **expenses** - Gastos deducibles con categorizaci√≥n
7. **subscriptions** - Facturaci√≥n recurrente
8. **payments** - Pagos parciales y m√∫ltiples por factura
9. **tax_events** - Calendario de obligaciones fiscales
10. **budgets** - Presupuestos por categor√≠a
11. **activity_log** - Registro de actividad del usuario

#### Caracter√≠sticas de la Base de Datos

- **UUID** como identificadores primarios
- **Timestamps autom√°ticos** (created_at, updated_at)
- **Triggers** para actualizaci√≥n de updated_at
- **√çndices optimizados** para queries frecuentes
- **Relaciones con integridad referencial**
- **Soft deletes** con campos de estado
- **Datos de demostraci√≥n** incluidos

### Archivo de Inicializaci√≥n

**Ubicaci√≥n**: `backend/src/database/init.sql`

El script SQL incluye:
- Creaci√≥n de todas las tablas con sus relaciones
- √çndices para optimizaci√≥n de consultas
- Triggers para campos autom√°ticos
- Extensi√≥n UUID para generaci√≥n de IDs
- Datos de ejemplo para desarrollo

---

## üîß Backend API

### Arquitectura

Se ha implementado una arquitectura RESTful completa con:

- **Framework**: Express.js 4.18.2
- **ORM/Query Builder**: pg (PostgreSQL native driver)
- **Autenticaci√≥n**: JWT + Passport.js (OAuth2)
- **Validaci√≥n**: express-validator
- **Seguridad**: bcrypt para passwords

### Modelos de Datos

Ubicaci√≥n: `backend/src/models/`

#### 1. User.js
- Creaci√≥n de usuarios (local + OAuth)
- Autenticaci√≥n y verificaci√≥n de contrase√±as
- Gesti√≥n de preferencias (tema, idioma)
- Actualizaci√≥n de last_login

#### 2. Client.js
- CRUD completo de clientes
- Filtros y b√∫squeda
- Estad√≠sticas por cliente
- Top clientes por facturaci√≥n

#### 3. Invoice.js
- CRUD completo con transacciones
- Gesti√≥n de items de factura
- C√°lculos fiscales autom√°ticos (IVA, IRPF)
- Marcar facturas como pagadas
- Actualizaci√≥n autom√°tica de facturas vencidas
- Estad√≠sticas e informes
- Ingresos mensuales

#### 4. Expense.js
- CRUD completo de gastos
- Categorizaci√≥n y subcategorizaci√≥n
- Gastos deducibles (porcentajes)
- IVA recuperable
- Estad√≠sticas por categor√≠a
- Gastos mensuales
- Top proveedores

#### 5. Project.js
- CRUD completo de proyectos
- Asociaci√≥n con clientes
- Estados del proyecto (activo, completado, en pausa, cancelado)
- Presupuestos y fechas
- Estad√≠sticas de proyecto

### Rutas API

Ubicaci√≥n: `backend/src/api/`

#### Autenticaci√≥n (`/api/auth`)

```
POST   /register                    - Registro de usuario local
POST   /login                       - Login con email/password
GET    /me                          - Obtener usuario actual
PUT    /me                          - Actualizar usuario actual
GET    /google                      - Iniciar OAuth con Google
GET    /google/callback             - Callback de Google
GET    /github                      - Iniciar OAuth con GitHub
GET    /github/callback             - Callback de GitHub
```

#### Facturas (`/api/invoices`)

```
GET    /                            - Listar facturas (con filtros)
GET    /statistics                  - Estad√≠sticas de facturas
GET    /monthly                     - Ingresos mensuales
GET    /:id                         - Obtener factura por ID
POST   /                            - Crear nueva factura
PUT    /:id                         - Actualizar factura
DELETE /:id                         - Eliminar factura
POST   /:id/mark-paid               - Marcar como pagada
POST   /update-overdue              - Actualizar facturas vencidas
```

#### Gastos (`/api/expenses`)

```
GET    /                            - Listar gastos (con filtros)
GET    /statistics                  - Estad√≠sticas de gastos
GET    /by-category                 - Gastos agrupados por categor√≠a
GET    /monthly                     - Gastos mensuales
GET    /top-vendors                 - Top proveedores
GET    /:id                         - Obtener gasto por ID
POST   /                            - Crear nuevo gasto
PUT    /:id                         - Actualizar gasto
DELETE /:id                         - Eliminar gasto
```

#### Clientes (`/api/clients`)

```
GET    /                            - Listar clientes (con filtros)
GET    /top                         - Top clientes por facturaci√≥n
GET    /:id                         - Obtener cliente por ID
GET    /:id/statistics              - Estad√≠sticas del cliente
POST   /                            - Crear nuevo cliente
PUT    /:id                         - Actualizar cliente
DELETE /:id                         - Eliminar cliente
```

#### Proyectos (`/api/projects`)

```
GET    /                            - Listar proyectos (con filtros)
GET    /:id                         - Obtener proyecto por ID
GET    /:id/statistics              - Estad√≠sticas del proyecto
POST   /                            - Crear nuevo proyecto
PUT    /:id                         - Actualizar proyecto
DELETE /:id                         - Eliminar proyecto
```

### Middleware

#### auth.js
- **authenticateToken**: Verificaci√≥n de JWT en rutas protegidas
- **generateToken**: Generaci√≥n de tokens JWT con expiraci√≥n

### Validaciones

Todas las rutas incluyen validaci√≥n de entrada con `express-validator`:
- Tipos de datos correctos
- Rangos v√°lidos
- Formato de emails, URLs, fechas
- Campos requeridos
- Sanitizaci√≥n de entrada

---

## üé® Frontend

### M√≥dulos Completados

#### 1. M√≥dulo de Gastos y Deducciones

**Archivo**: `frontend/src/pages/expenses.js` (825 l√≠neas)

**Caracter√≠sticas:**
- ‚úÖ Tarjetas de resumen con KPIs
  - Gastos totales
  - Gastos deducibles
  - IVA recuperable
  - Promedio por gasto

- ‚úÖ Filtros avanzados
  - B√∫squeda por descripci√≥n/proveedor
  - Filtro por categor√≠a (10 categor√≠as)
  - Filtro por deducibilidad
  - Rango de fechas
  - Rango de importes

- ‚úÖ Tabla de gastos
  - Ordenaci√≥n y paginaci√≥n
  - Estados visuales por categor√≠a
  - Indicadores de deducibilidad
  - Acciones por gasto (ver, editar, eliminar)

- ‚úÖ Formulario completo
  - Categorizaci√≥n y subcategorizaci√≥n
  - C√°lculo autom√°tico de IVA
  - Porcentaje de deducibilidad ajustable
  - M√©todos de pago
  - Adjuntar recibos (URL)
  - Notas adicionales

- ‚úÖ Gr√°ficos y visualizaciones
  - Gastos por categor√≠a (barras horizontales)
  - Evoluci√≥n mensual
  - Top 5 proveedores

- ‚úÖ Datos de demostraci√≥n
  - 5 gastos de ejemplo con diferentes categor√≠as
  - Categor√≠as: Software, Oficina, Viajes, Comidas, Hardware

#### 2. M√≥dulo de Clientes y Proyectos

**Archivo**: `frontend/src/pages/clients.js` (1057 l√≠neas)

**Caracter√≠sticas:**

##### Tab de Clientes

- ‚úÖ Tarjetas de resumen
  - Total de clientes
  - Clientes activos
  - Nuevos este mes
  - Facturaci√≥n media

- ‚úÖ Filtros
  - B√∫squeda por nombre, email, NIF/CIF
  - Filtro por estado (activos/inactivos)

- ‚úÖ Grid de clientes (cards)
  - Avatar con inicial
  - Informaci√≥n de contacto
  - Datos fiscales (NIF/CIF)
  - Estado visual (activo/inactivo)
  - Notas del cliente
  - Acciones: Ver, Editar, Eliminar

- ‚úÖ Formulario de cliente
  - Datos b√°sicos (nombre, email, tel√©fono, NIF/CIF)
  - Direcci√≥n completa (calle, ciudad, CP, pa√≠s)
  - Notas adicionales
  - Estado activo/inactivo

##### Tab de Proyectos

- ‚úÖ Tarjetas de resumen
  - Total de proyectos
  - Proyectos activos
  - Proyectos completados
  - Presupuesto total

- ‚úÖ Filtros
  - B√∫squeda por nombre
  - Filtro por estado (activo, completado, en pausa, cancelado)
  - Filtro por cliente

- ‚úÖ Grid de proyectos (cards)
  - Barra de color identificativa
  - Estado con badge
  - Informaci√≥n del cliente
  - Descripci√≥n del proyecto
  - Presupuesto y fechas
  - Acciones: Ver, Editar, Eliminar

- ‚úÖ Formulario de proyecto
  - Nombre y descripci√≥n
  - Selecci√≥n de cliente
  - Estado del proyecto (4 estados)
  - Presupuesto
  - Fechas de inicio y fin
  - Selector de color para identificaci√≥n visual

- ‚úÖ Datos de demostraci√≥n
  - 5 clientes de ejemplo
  - 4 proyectos vinculados a clientes

---

## üìù Configuraci√≥n y Variables de Entorno

### Backend (.env)

```env
FRONTEND_PORT=3020
BACKEND_PORT=8020
DB_PORT=5452

# Database Configuration
DB_HOST=localhost
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=anclora_flow
DATABASE_URL=postgresql://postgres:postgres@localhost:5452/anclora_flow

# JWT Configuration
JWT_SECRET=anclora_flow_secret_key_change_in_production_2024
JWT_EXPIRES_IN=7d

# OAuth Configuration
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret

# Application
NODE_ENV=development
FRONTEND_URL=http://localhost:3020
```

---

## üöÄ C√≥mo Ejecutar el Proyecto

### Requisitos Previos

- Node.js 20+ instalado
- PostgreSQL 13+ instalado y corriendo
- npm o yarn

### Instalaci√≥n

#### 1. Backend

```bash
cd backend
npm install
```

#### 2. Base de Datos

```bash
# Crear la base de datos
createdb anclora_flow

# O con psql:
psql -U postgres -c "CREATE DATABASE anclora_flow;"

# Inicializar las tablas
psql -U postgres -d anclora_flow -f src/database/init.sql
```

#### 3. Frontend

```bash
cd frontend
npm install
```

### Ejecuci√≥n

#### Backend (Puerto 8020)

```bash
cd backend
npm run dev
```

El servidor estar√° disponible en `http://localhost:8020`

Endpoints disponibles:
- Health check: `http://localhost:8020/api/health`
- Auth API: `http://localhost:8020/api/auth`
- Invoices API: `http://localhost:8020/api/invoices`
- Expenses API: `http://localhost:8020/api/expenses`
- Clients API: `http://localhost:8020/api/clients`
- Projects API: `http://localhost:8020/api/projects`

#### Frontend (Puerto 3020)

```bash
cd frontend
npm run dev
```

La aplicaci√≥n estar√° disponible en `http://localhost:3020`

---

## üìä Estado del Proyecto

### ‚úÖ Completado

1. **Base de Datos**
   - [x] Dise√±o completo del esquema
   - [x] Script de inicializaci√≥n
   - [x] Configuraci√≥n de conexi√≥n
   - [x] Modelos de datos

2. **Backend API**
   - [x] Servidor Express configurado
   - [x] Middleware de autenticaci√≥n JWT
   - [x] API de Autenticaci√≥n (local + OAuth)
   - [x] API de Facturas (CRUD completo)
   - [x] API de Gastos (CRUD completo)
   - [x] API de Clientes (CRUD completo)
   - [x] API de Proyectos (CRUD completo)
   - [x] Validaciones con express-validator
   - [x] Manejo de errores

3. **Frontend**
   - [x] Dashboard principal
   - [x] M√≥dulo de Facturas (completado previamente)
   - [x] **M√≥dulo de Gastos (NUEVO - COMPLETO)**
   - [x] **M√≥dulo de Clientes y Proyectos (NUEVO - COMPLETO)**
   - [x] Sistema de dise√±o y temas
   - [x] Autenticaci√≥n OAuth

### ‚è≥ Pendiente

1. **Integraci√≥n Frontend-Backend**
   - [ ] Conectar m√≥dulo de Facturas con API
   - [ ] Conectar m√≥dulo de Gastos con API
   - [ ] Conectar m√≥dulo de Clientes con API
   - [ ] Sistema de autenticaci√≥n completo

2. **Funcionalidades Avanzadas**
   - [ ] Gesti√≥n de pagos en facturas
   - [ ] Exportaci√≥n PDF/Excel
   - [ ] M√≥dulo de Suscripciones
   - [ ] Presupuesto Inteligente
   - [ ] Calendario Fiscal con fechas espa√±olas
   - [ ] Informes y M√©tricas avanzadas
   - [ ] Asistente IA

3. **Testing**
   - [ ] Tests unitarios del backend
   - [ ] Tests de integraci√≥n
   - [ ] Tests E2E del frontend

4. **Deployment**
   - [ ] Configuraci√≥n de Docker Compose completa
   - [ ] Variables de entorno de producci√≥n
   - [ ] CI/CD pipeline

---

## üîê Seguridad

### Implementado

- ‚úÖ Hashing de contrase√±as con bcrypt (10 rounds)
- ‚úÖ Autenticaci√≥n JWT con expiraci√≥n
- ‚úÖ Middleware de autenticaci√≥n en rutas protegidas
- ‚úÖ Validaci√≥n y sanitizaci√≥n de entrada
- ‚úÖ CORS configurado
- ‚úÖ Variables de entorno para secretos
- ‚úÖ Prepared statements (SQL injection prevention)

### Recomendaciones para Producci√≥n

- [ ] Cambiar JWT_SECRET a un valor fuerte y aleatorio
- [ ] Habilitar HTTPS
- [ ] Rate limiting en endpoints de autenticaci√≥n
- [ ] Configurar helmet.js para headers de seguridad
- [ ] Implementar CSRF protection
- [ ] Auditor√≠a de dependencias regular (npm audit)
- [ ] Backup autom√°tico de base de datos
- [ ] Logging y monitoreo

---

## üìÅ Estructura de Archivos Actualizada

```
/home/user/Anclora-Flow/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.js          (185 l√≠neas) ‚ú® ACTUALIZADO
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ invoices/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.js          (231 l√≠neas) ‚ú® NUEVO
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ expenses/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.js          (199 l√≠neas) ‚ú® NUEVO
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ clients/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.js          (126 l√≠neas) ‚ú® NUEVO
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ projects/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ routes.js          (119 l√≠neas) ‚ú® NUEVO
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ init.sql               (316 l√≠neas) ‚ú® NUEVO
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.js              (82 l√≠neas) ‚ú® NUEVO
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.js                (45 l√≠neas) ‚ú® NUEVO
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.js                (92 l√≠neas) ‚ú® NUEVO
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Client.js              (148 l√≠neas) ‚ú® NUEVO
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Invoice.js             (341 l√≠neas) ‚ú® NUEVO
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Expense.js             (225 l√≠neas) ‚ú® NUEVO
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Project.js             (126 l√≠neas) ‚ú® NUEVO
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server.js                  (92 l√≠neas) ‚ú® ACTUALIZADO
‚îÇ   ‚îú‚îÄ‚îÄ .env                           ‚ú® NUEVO
‚îÇ   ‚îú‚îÄ‚îÄ .env.example                   ‚ú® ACTUALIZADO
‚îÇ   ‚îî‚îÄ‚îÄ package.json                   ‚ú® ACTUALIZADO (+6 dependencias)
‚îÇ
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ expenses.js            (825 l√≠neas) ‚ú® COMPLETADO
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ clients.js             (1057 l√≠neas) ‚ú® COMPLETADO
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.js                    ‚ú® ACTUALIZADO (nuevas importaciones)
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ
‚îî‚îÄ‚îÄ DEVELOPMENT_UPDATE.md              ‚ú® NUEVO (este archivo)
```

---

## üéØ Pr√≥ximos Pasos Recomendados

### Corto Plazo (1-2 semanas)

1. **Conectar Frontend con Backend**
   - Implementar servicio API en frontend
   - Reemplazar datos demo con llamadas API
   - Gesti√≥n de estados de carga y errores

2. **Sistema de Autenticaci√≥n Completo**
   - Login funcional con JWT
   - Persistencia de sesi√≥n
   - Protecci√≥n de rutas
   - Refresh tokens

3. **Gesti√≥n de Pagos**
   - Implementar modal de a√±adir pago
   - Registro de pagos parciales
   - Actualizaci√≥n de estado de factura
   - Hist√≥rico de pagos

### Medio Plazo (3-4 semanas)

1. **Exportaci√≥n de Documentos**
   - Generaci√≥n de PDF de facturas
   - Exportaci√≥n Excel de informes
   - Plantillas personalizables

2. **M√≥dulo de Suscripciones**
   - Facturaci√≥n recurrente
   - Renovaci√≥n autom√°tica
   - Gesti√≥n de ciclos

3. **Calendario Fiscal Espa√±ol**
   - Modelos 303, 130, 111
   - Alertas de vencimientos
   - C√°lculo autom√°tico

### Largo Plazo (2-3 meses)

1. **Asistente IA**
   - Integraci√≥n con servicios de IA
   - Sistema RAG para documentos fiscales
   - Recomendaciones inteligentes

2. **Informes Avanzados**
   - Dashboard anal√≠tico completo
   - Exportaci√≥n personalizada
   - Gr√°ficos interactivos

3. **Multi-tenant**
   - Soporte para m√∫ltiples empresas
   - Roles y permisos
   - Facturaci√≥n por usuario

---

## üêõ Problemas Conocidos

1. **Dependencias del Backend**
   - Warnings de deprecaci√≥n en algunas dependencias (inflight, glob, etc.)
   - No afectan la funcionalidad actual
   - Considerar actualizaci√≥n en el futuro

2. **Vulnerabilidades**
   - 2 vulnerabilidades de severidad moderada detectadas
   - Revisar con `npm audit` y actualizar si es necesario

3. **OAuth**
   - Configuraci√≥n de Google/GitHub OAuth pendiente de credenciales reales
   - Actualmente usa placeholders en .env

---

## üìû Soporte

Para dudas o problemas con la implementaci√≥n:

1. Revisar este documento de actualizaci√≥n
2. Consultar README_ES.md o README_EN.md
3. Verificar logs del servidor backend
4. Comprobar configuraci√≥n de .env

---

## üìù Notas del Desarrollador

### Decisiones de Arquitectura

1. **Base de Datos**
   - Se opt√≥ por PostgreSQL por su robustez y soporte para tipos de datos complejos
   - UUID como IDs para escalabilidad y seguridad
   - Soft deletes en lugar de borrados f√≠sicos

2. **Backend**
   - Express.js por su simplicidad y ecosistema maduro
   - pg driver nativo en lugar de ORM para mayor control
   - Patr√≥n de modelos para encapsular l√≥gica de datos

3. **Frontend**
   - Vanilla JS mantenido para consistencia con el c√≥digo existente
   - Modales para formularios (mejor UX que p√°ginas separadas)
   - Datos demo incluidos para testing sin backend

### Testing Recomendado

Antes de hacer commit, verificar:

```bash
# Backend
cd backend
npm run dev
# Verificar que inicia sin errores
# Probar endpoints con curl o Postman

# Frontend
cd frontend
npm run dev
# Navegar a /expenses y /clients
# Verificar que los m√≥dulos cargan correctamente
# Probar filtros y formularios
```

---

**Fecha de Actualizaci√≥n**: Diciembre 2024
**Versi√≥n**: 2.0.0-dev
**Desarrollador**: Claude (Anthropic)
