# üîó Integraci√≥n Frontend-Backend con Verifactu

Gu√≠a completa para conectar el frontend de Anclora Flow con el backend y habilitar todas las funcionalidades de Verifactu.

## üìã Estado Actual

### ‚úÖ Backend (Completado)
- API REST completa con 11 endpoints Verifactu
- Servicio Verifactu con blockchain de facturas
- Base de datos PostgreSQL con migraci√≥n aplicada
- Autenticaci√≥n JWT funcionando

### ‚úÖ Frontend - Creado en Esta Sesi√≥n
- **`/frontend/src/services/api.js`** - Servicio API centralizado
- **`/frontend/login.html`** - P√°gina de login
- **`/frontend/register.html`** - P√°gina de registro
- **`/frontend/src/services/auth-guard.js`** - Middleware de autenticaci√≥n

### üöß Pendiente
- Conectar m√≥dulo de facturas con API real
- Implementar UI para acciones de Verifactu
- Modales para QR y CSV

---

## üéØ C√≥mo Funciona Verifactu (Perspectiva del Usuario)

### 1. Vista Principal de Facturas

Cuando el usuario accede al m√≥dulo de Facturas (`/invoices`), ve una tabla con **todas sus facturas** que incluye una **nueva columna "Verifactu"**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ N¬∫ Factura  ‚îÇ Cliente      ‚îÇ Emision ‚îÇ Total   ‚îÇ Estado       ‚îÇ Verifactu  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ F2025-001   ‚îÇ Cliente A    ‚îÇ 15/01   ‚îÇ 2.650‚Ç¨  ‚îÇ ‚óè Cobrada    ‚îÇ ‚úÖ Regist  ‚îÇ
‚îÇ F2025-002   ‚îÇ Cliente B    ‚îÇ 01/02   ‚îÇ 1.224‚Ç¨  ‚îÇ ‚óè Enviada    ‚îÇ ‚è≥ Pend    ‚îÇ
‚îÇ F2025-003   ‚îÇ Cliente C    ‚îÇ 15/02   ‚îÇ   648‚Ç¨  ‚îÇ ‚óè Pendiente  ‚îÇ ‚ö™ No reg  ‚îÇ
‚îÇ F2025-004   ‚îÇ Cliente D    ‚îÇ 01/03   ‚îÇ 3.710‚Ç¨  ‚îÇ ‚óè Vencida    ‚îÇ ‚ùå Error   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2. Estados de Verifactu

| Estado | Icono | Significado | Acciones Disponibles |
|--------|-------|-------------|----------------------|
| **No registrada** | ‚ö™ | Factura no enviada a AEAT | **üìã Registrar** |
| **Pendiente** | ‚è≥ | Registro en proceso | *(deshabilitado)* |
| **Registrada** | ‚úÖ | Correctamente registrada | **üî≤ Ver QR**, **üîê Ver CSV** |
| **Error** | ‚ùå | Fall√≥ el registro | **üîÑ Reintentar** |

### 3. Flujo de Trabajo Completo

#### A. Crear Nueva Factura

1. Usuario hace clic en **"Nueva factura"**
2. Rellena formulario:
   - Datos del cliente
   - Conceptos/l√≠neas
   - Importes, IVA, IRPF
3. Guarda la factura
4. La factura aparece en la tabla con estado **‚ö™ No registrada**

#### B. Registrar en Verifactu

```mermaid
graph TD
    A[Factura creada] --> B{¬øRegistrar en Verifactu?}
    B -->|S√≠| C[Usuario hace clic en üìã Registrar]
    C --> D[Estado cambia a ‚è≥ Pendiente]
    D --> E{Backend procesa}
    E -->|√âxito| F[Estado cambia a ‚úÖ Registrada]
    E -->|Error| G[Estado cambia a ‚ùå Error]
    F --> H[Usuario puede ver QR y CSV]
    G --> I[Usuario puede reintentar]
    B -->|No| J[Factura queda sin registrar]
```

#### C. Ver Datos de Verificaci√≥n

Cuando una factura est√° **‚úÖ Registrada**, el usuario puede:

**1. Ver C√≥digo QR (bot√≥n üî≤)**
- Se abre un modal mostrando el c√≥digo QR
- El QR contiene la URL de verificaci√≥n de la AEAT
- Usuario puede:
  - Escanearlo con su m√≥vil
  - Descargarlo como imagen
  - Imprimirlo junto con la factura

**2. Ver CSV (bot√≥n üîê)**
- Se abre un modal mostrando el C√≥digo Seguro de Verificaci√≥n
- Ejemplo: `4A2F9E8B1C6D5A3E`
- Usuario puede:
  - Copiarlo al portapapeles
  - Incluirlo en la factura PDF
  - Compartirlo con el cliente

---

## üîß Implementaci√≥n T√©cnica

### Paso 1: Verificar Backend Funcionando

```powershell
# Verificar que el backend est√© corriendo
curl http://localhost:8020/api/health

# Deber√≠a responder:
# {"status":"ok","message":"Anclora Flow API est√° funcionando"}
```

### Paso 2: Crear Usuario de Prueba

#### Opci√≥n A: Desde el Frontend

1. Abre http://localhost:3020/register.html
2. Rellena el formulario:
   - Nombre: Tu Nombre
   - Email: tu@email.com
   - NIF: 12345678A
   - Contrase√±a: password123
3. Haz clic en "Crear cuenta"
4. Ser√°s redirigido autom√°ticamente al dashboard

#### Opci√≥n B: Desde API directamente

```powershell
$body = @{
    name = "Usuario Test"
    email = "test@anclora.com"
    password = "password123"
    nif = "12345678A"
} | ConvertTo-Json

$response = Invoke-RestMethod -Uri "http://localhost:8020/api/auth/register" `
    -Method Post `
    -Body $body `
    -ContentType "application/json"

$response
# Guarda el token: $response.token
```

### Paso 3: Crear Factura de Prueba

```powershell
# Usar el token del paso anterior
$token = "tu_token_aqui"

$invoice = @{
    invoice_number = "F2025-001"
    client_name = "Cliente Ejemplo SL"
    client_email = "cliente@ejemplo.com"
    client_nif = "B12345678"
    issue_date = "2025-01-15"
    due_date = "2025-02-15"
    subtotal = 1000.00
    tax = 210.00  # IVA 21%
    total = 1210.00
    status = "sent"
    notes = "Factura de ejemplo"
} | ConvertTo-Json

$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

$newInvoice = Invoke-RestMethod `
    -Uri "http://localhost:8020/api/invoices" `
    -Method Post `
    -Headers $headers `
    -Body $invoice

$newInvoice
# Guarda el ID: $newInvoice.id
```

### Paso 4: Registrar en Verifactu

```powershell
$invoiceId = $newInvoice.id

$verifactu = Invoke-RestMethod `
    -Uri "http://localhost:8020/api/verifactu/register/$invoiceId" `
    -Method Post `
    -Headers $headers

$verifactu
# Ver√°s: verifactu_status: "registered", verifactu_hash, verifactu_csv, etc.
```

### Paso 5: Ver Estado de Verifactu

```powershell
$status = Invoke-RestMethod `
    -Uri "http://localhost:8020/api/verifactu/status/$invoiceId" `
    -Headers $headers

$status
```

### Paso 6: Ver Estad√≠sticas

```powershell
$stats = Invoke-RestMethod `
    -Uri "http://localhost:8020/api/verifactu/statistics" `
    -Headers $headers

$stats
# Ver√°s: total_registered, total_pending, total_errors, etc.
```

---

## üíª Integraci√≥n en el Frontend

### Estructura de Archivos Creados

```
frontend/
‚îú‚îÄ‚îÄ login.html                          # ‚úÖ P√°gina de login
‚îú‚îÄ‚îÄ register.html                       # ‚úÖ P√°gina de registro
‚îî‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ services/
    ‚îÇ   ‚îú‚îÄ‚îÄ api.js                     # ‚úÖ Servicio API centralizado
    ‚îÇ   ‚îî‚îÄ‚îÄ auth-guard.js              # ‚úÖ Middleware de autenticaci√≥n
    ‚îî‚îÄ‚îÄ pages/
        ‚îî‚îÄ‚îÄ invoices.js                # üöß Actualizar para usar API real
```

### Ejemplo: Conectar M√≥dulo de Facturas

Actualmente `frontend/src/pages/invoices.js` tiene datos hardcodeados. Para conectarlo con la API:

```javascript
// frontend/src/pages/invoices.js

import api from '../services/api.js';

// Estado global de facturas
let invoices = [];
let isLoading = false;

// Cargar facturas desde la API
async function loadInvoices() {
  isLoading = true;
  renderLoadingState();

  try {
    const response = await api.getInvoices();
    invoices = response.invoices || [];
    renderInvoices();
  } catch (error) {
    console.error('Error cargando facturas:', error);
    renderErrorState(error.message);
  } finally {
    isLoading = false;
  }
}

// Registrar factura en Verifactu
async function registerVerifactu(invoiceId) {
  try {
    const result = await api.registerInvoiceVerifactu(invoiceId);

    // Actualizar factura en la lista local
    const invoice = invoices.find(inv => inv.id === invoiceId);
    if (invoice) {
      invoice.verifactu_status = 'registered';
      invoice.verifactu_csv = result.verifactu_csv;
      invoice.verifactu_qr_code = result.verifactu_qr_code;
      invoice.verifactu_url = result.verifactu_url;
    }

    // Re-renderizar tabla
    renderInvoices();

    // Mostrar notificaci√≥n de √©xito
    showNotification('Factura registrada en Verifactu correctamente', 'success');
  } catch (error) {
    console.error('Error registrando en Verifactu:', error);
    showNotification(`Error: ${error.message}`, 'error');
  }
}

// Ver QR de Verifactu
function showVerifactuQR(invoice) {
  const modal = document.createElement('div');
  modal.className = 'modal modal--open';
  modal.innerHTML = `
    <div class="modal__backdrop"></div>
    <div class="modal__panel">
      <header class="modal__head">
        <h2>C√≥digo QR - Verifactu</h2>
        <button class="modal__close" onclick="this.closest('.modal').remove()">√ó</button>
      </header>
      <div class="modal__body">
        <p><strong>Factura:</strong> ${invoice.invoice_number}</p>
        <p><strong>CSV:</strong> ${invoice.verifactu_csv}</p>
        <div style="text-align: center; padding: 2rem;">
          <img src="${invoice.verifactu_qr_code}" alt="QR Verifactu" style="max-width: 300px;">
        </div>
        <p style="font-size: 0.9rem; color: #666;">
          Escanea este c√≥digo QR para verificar la factura en la web de la Agencia Tributaria.
        </p>
      </div>
      <footer class="modal__footer">
        <button class="btn-secondary" onclick="this.closest('.modal').remove()">Cerrar</button>
        <a href="${invoice.verifactu_qr_code}" download="qr-${invoice.invoice_number}.png" class="btn-primary">
          Descargar QR
        </a>
      </footer>
    </div>
  `;
  document.body.appendChild(modal);
}

// Ver CSV de Verifactu
function showVerifactuCSV(invoice) {
  const modal = document.createElement('div');
  modal.className = 'modal modal--open';
  modal.innerHTML = `
    <div class="modal__backdrop"></div>
    <div class="modal__panel">
      <header class="modal__head">
        <h2>C√≥digo Seguro de Verificaci√≥n (CSV)</h2>
        <button class="modal__close" onclick="this.closest('.modal').remove()">√ó</button>
      </header>
      <div class="modal__body">
        <p><strong>Factura:</strong> ${invoice.invoice_number}</p>
        <div style="text-align: center; padding: 2rem;">
          <div style="background: #f7fafc; border: 2px dashed #cbd5e0; padding: 1.5rem; border-radius: 8px;">
            <p style="font-size: 0.9rem; color: #718096; margin-bottom: 0.5rem;">C√≥digo Seguro de Verificaci√≥n</p>
            <p style="font-size: 2rem; font-weight: bold; font-family: monospace; letter-spacing: 4px; color: #2d3748;">
              ${invoice.verifactu_csv}
            </p>
          </div>
        </div>
        <p style="font-size: 0.9rem; color: #666;">
          Este c√≥digo CSV identifica de forma √∫nica esta factura en el sistema Verifactu de la AEAT.
        </p>
      </div>
      <footer class="modal__footer">
        <button class="btn-secondary" onclick="this.closest('.modal').remove()">Cerrar</button>
        <button class="btn-primary" onclick="navigator.clipboard.writeText('${invoice.verifactu_csv}'); alert('CSV copiado al portapapeles')">
          Copiar CSV
        </button>
      </footer>
    </div>
  `;
  document.body.appendChild(modal);
}

// Exportar funciones
export { loadInvoices, registerVerifactu, showVerifactuQR, showVerifactuCSV };
```

---

## üé® UI/UX de Verifactu

### Badges de Estado

```css
/* Estilos para badges de Verifactu */
.verifactu-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.25rem 0.75rem;
  border-radius: 999px;
  font-size: 0.85rem;
  font-weight: 600;
}

.verifactu-badge--registered {
  background: #c6f6d5;
  color: #2f855a;
}

.verifactu-badge--pending {
  background: #feebc8;
  color: #c05621;
}

.verifactu-badge--error {
  background: #fed7d7;
  color: #c53030;
}

.verifactu-badge--not-registered {
  background: #e2e8f0;
  color: #4a5568;
}
```

### Botones de Acci√≥n

```html
<!-- Bot√≥n Registrar (cuando NO est√° registrada) -->
<button class="btn-verifactu" onclick="registerVerifactu('${invoice.id}')">
  üìã Registrar en Verifactu
</button>

<!-- Botones Ver QR y CSV (cuando est√° registrada) -->
<button class="btn-icon" onclick="showVerifactuQR(invoice)" title="Ver QR">
  üî≤
</button>
<button class="btn-icon" onclick="showVerifactuCSV(invoice)" title="Ver CSV">
  üîê
</button>
```

---

## üìä Dashboard de Verifactu

Opcionalmente, puedes crear un widget en el dashboard que muestre estad√≠sticas:

```javascript
// Cargar estad√≠sticas de Verifactu
async function loadVerifactuStats() {
  try {
    const stats = await api.getVerifactuStatistics();

    return `
      <div class="widget verifactu-stats">
        <h3>Verifactu - Estado</h3>
        <div class="stats-grid">
          <div class="stat">
            <span class="stat-value">${stats.total_registered}</span>
            <span class="stat-label">Registradas</span>
          </div>
          <div class="stat">
            <span class="stat-value">${stats.total_pending}</span>
            <span class="stat-label">Pendientes</span>
          </div>
          <div class="stat stat--error">
            <span class="stat-value">${stats.total_errors}</span>
            <span class="stat-label">Errores</span>
          </div>
        </div>
      </div>
    `;
  } catch (error) {
    console.error('Error cargando stats Verifactu:', error);
    return '';
  }
}
```

---

## üß™ Testing Completo

### Test 1: Autenticaci√≥n

```powershell
# 1. Registrar usuario
# 2. Login
# 3. Verificar que el token se guarda en localStorage
# 4. Intentar acceder a p√°gina protegida
```

### Test 2: CRUD de Facturas

```powershell
# 1. Crear factura
# 2. Listar facturas
# 3. Actualizar factura
# 4. Eliminar factura
```

### Test 3: Verifactu Completo

```powershell
# 1. Crear factura
# 2. Registrar en Verifactu (debe estar en "registered")
# 3. Ver QR (debe generarse correctamente)
# 4. Ver CSV (debe ser un c√≥digo de 16 caracteres)
# 5. Verificar cadena de blockchain
# 6. Crear segunda factura y registrar (debe enlazar con la primera)
```

---

## ‚ùì FAQs

### ¬øPor qu√© no veo la columna Verifactu en el frontend?

**Respuesta:** La columna est√° en el c√≥digo (`frontend/src/pages/invoices.js` l√≠nea 480), pero actualmente usa **datos est√°ticos de ejemplo**. Para ver datos reales:

1. Conecta el m√≥dulo con la API (ver secci√≥n "Integraci√≥n en el Frontend")
2. Crea facturas desde la API
3. Reg√≠stralas en Verifactu
4. Recarga el frontend

### ¬øC√≥mo saber si una factura se registr√≥ correctamente?

Verifica la respuesta del endpoint `/api/verifactu/register/:id`:

```json
{
  "success": true,
  "invoice": {
    "verifactu_status": "registered",
    "verifactu_hash": "abc123...",
    "verifactu_csv": "4A2F9E8B1C6D5A3E",
    "verifactu_qr_code": "data:image/png;base64,...",
    "verifactu_url": "https://..."
  }
}
```

### ¬øQu√© pasa si hay un error al registrar?

El status cambiar√° a `"error"` y habr√° un mensaje en `verifactu_error_message`. El usuario puede:

1. Ver el error en los logs: `GET /api/verifactu/logs?invoice_id=<id>`
2. Reintentar el registro: Click en bot√≥n üîÑ

### ¬øC√≥mo funciona la cadena de blockchain?

Cada factura contiene:
- `verifactu_hash`: Hash SHA-256 de la factura actual
- `verifactu_previous_hash`: Hash de la factura anterior
- `verifactu_chain_index`: Posici√≥n en la cadena

Para verificar la integridad:
```powershell
$chain = Invoke-RestMethod `
    -Uri "http://localhost:8020/api/verifactu/verify-chain" `
    -Headers $headers

$chain
# {  "valid": true,  "total_invoices": 10,  "chain_breaks": [] }
```

---

## üìù Pr√≥ximos Pasos

1. **Modificar `frontend/src/pages/invoices.js`** para usar `api.getInvoices()`
2. **A√±adir event handlers** para botones de Verifactu
3. **Crear modales** para QR y CSV
4. **A√±adir widget** de estad√≠sticas Verifactu en dashboard
5. **Testing end-to-end** del flujo completo

---

## üéâ Resultado Final

Cuando todo est√© integrado, el usuario podr√°:

1. ‚úÖ Crear facturas desde el frontend
2. ‚úÖ Ver todas sus facturas con su estado de Verifactu
3. ‚úÖ Registrar facturas en Verifactu con un clic
4. ‚úÖ Ver c√≥digos QR de verificaci√≥n
5. ‚úÖ Ver y copiar c√≥digos CSV
6. ‚úÖ Ver estad√≠sticas de registros
7. ‚úÖ Verificar integridad de la cadena blockchain

Todo esto con **seguridad de la Agencia Tributaria** y **trazabilidad completa**.
